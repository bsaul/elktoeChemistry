<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preprocess data • elktoeChemistry</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Preprocess data">
<meta property="og:description" content="elktoeChemistry">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">elktoeChemistry</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Preparation
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/preprocess_data.html">Preprocessing Data</a>
    </li>
    <li>
      <a href="../articles/prepare_analysis_data.html">Preparing Analysis Data</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Results
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/study_map.html">Study map</a>
    </li>
    <li>
      <a href="../articles/diversity.html">Elemental diversity</a>
    </li>
    <li>
      <a href="../articles/summarize_elements.html">Summarize elements</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="preprocess_data_files/header-attrs-2.6/header-attrs.js"></script><script src="preprocess_data_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Preprocess data</h1>
                        <h4 class="author">Bradley Saul</h4>
            
            <h4 class="date">2020-12-22</h4>
      
      
      <div class="hidden name"><code>preprocess_data.Rmd</code></div>

    </div>

    
    
<div id="using-this-document" class="section level1">
<h1 class="hasAnchor">
<a href="#using-this-document" class="anchor"></a>Using this document</h1>
<p>This document both details the process of preparing the valve data for analysis and when executed performs the data preparation steps.</p>
<p>The header of the document specifies the locations of the input files (or directories):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">inputs</span><span class="op">)</span>
<span class="co">#&gt; $chemistry_dir</span>
<span class="co">#&gt; [1] "../extdata/Data/Geochemical Time-Series"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $baseline_specimens</span>
<span class="co">#&gt; [1] "../extdata/Mussel Metrics Data - Baseline.xlsx"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $lod</span>
<span class="co">#&gt; [1] "../extdata/Std recoveries comp D1-7 reproc.xlsx"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $meausurements</span>
<span class="co">#&gt; [1] "../extdata/Data/Bivalve Transect Datums.xlsx"</span></code></pre></div>
<p>as well as the outputs:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">outputs</span><span class="op">)</span>
<span class="co">#&gt; $chemistry</span>
<span class="co">#&gt; [1] "../data/valve_chemistry.rds"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $lod</span>
<span class="co">#&gt; [1] "../data/lower_detection_limits.rds"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $measurements</span>
<span class="co">#&gt; [1] "../data/valve_measurements.rds"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $valve_data</span>
<span class="co">#&gt; [1] "../data/valve_data.rds"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $element_info</span>
<span class="co">#&gt; [1] "../data/element_info.rds"</span></code></pre></div>
<p>These settings can be changed as needed.</p>
</div>
<div id="collecting-necessary-data" class="section level1">
<h1 class="hasAnchor">
<a href="#collecting-necessary-data" class="anchor"></a>Collecting Necessary Data</h1>
<p>The <code>elktoeChemistry</code> R package contains the source data and functions needed for the data processing.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">elktoeChemistry</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span></code></pre></div>
<div id="covariates-and-outcomes" class="section level2">
<h2 class="hasAnchor">
<a href="#covariates-and-outcomes" class="anchor"></a>Covariates and Outcomes</h2>
<p>The <code>elktoeChemistry</code> packages includes a <code>data.frame</code> with information on the study specimens exposed to the experiment. Variables ending in:</p>
<ul>
<li>
<code>_0</code> are measurements at baseline;</li>
<li>
<code>_1</code> are measurements when the specimen was pulled from experiment;</li>
<li>
<code>_d</code> are differences between baseline and end (<code>*_1 - *_0</code>).</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">mussels_wide</span><span class="op">)</span>
<span class="co">#&gt; 'data.frame':    144 obs. of  47 variables:</span>
<span class="co">#&gt;  $ site              : chr  "LiTN 1" "LiTN 1" "LiTN 1" "LiTN 1" ...</span>
<span class="co">#&gt;  $ id                : chr  "P165" "P118" "P161" "P114" ...</span>
<span class="co">#&gt;  $ river             : chr  "Little Tennessee" "Little Tennessee" "Little Tennessee" "Little Tennessee" ...</span>
<span class="co">#&gt;  $ species           : chr  "L. fasciola" "L. fasciola" "L. fasciola" "L. fasciola" ...</span>
<span class="co">#&gt;  $ dry_weight_g_1    : num  5.7 6.3 8.1 6.4 NA 53 34.4 37.4 NA 13.3 ...</span>
<span class="co">#&gt;  $ buoyant_weight_g_1: num  1.6 2 2.3 1.4 NA 8.7 10.4 4.8 NA 3 ...</span>
<span class="co">#&gt;  $ length_mm_1       : num  34 36 35 33.8 NA 78 71 70 68.9 49.5 ...</span>
<span class="co">#&gt;  $ width_mm_1        : num  21 23 25 25 NA 38 34 36 36.3 25 ...</span>
<span class="co">#&gt;  $ height_mm_1       : num  14 14 17 13.9 NA 30 27 25 23.8 17.5 ...</span>
<span class="co">#&gt;  $ date_1            : Date, format: "2013-09-19" "2013-09-19" ...</span>
<span class="co">#&gt;  $ dead_1            : int  0 0 0 0 NA 0 0 0 1 0 ...</span>
<span class="co">#&gt;  $ s_dry_1           : num  0.146 0.422 1.25 0.468 NA ...</span>
<span class="co">#&gt;  $ s_buoyant_1       : num  -0.3919 -0.0249 0.2503 -0.5754 NA ...</span>
<span class="co">#&gt;  $ s_volume_1        : num  0.216 0.641 1.515 0.682 NA ...</span>
<span class="co">#&gt;  $ s_width_1         : num  0.258 0.925 1.592 1.592 NA ...</span>
<span class="co">#&gt;  $ s_height_1        : num  0.262 0.262 1.423 0.223 NA ...</span>
<span class="co">#&gt;  $ s_length_1        : num  0.401 0.893 0.647 0.352 NA ...</span>
<span class="co">#&gt;  $ volume_1          : num  9996 11592 14875 11745 NA ...</span>
<span class="co">#&gt;  $ corb_density_1    : num  29.6 29.6 29.6 29.6 29.6 29.6 29.6 29.6 29.6 29.6 ...</span>
<span class="co">#&gt;  $ dry_weight_g_0    : num  3.8 3.3 4.8 2.4 NA NA NA NA NA NA ...</span>
<span class="co">#&gt;  $ buoyant_weight_g_0: num  NA NA NA NA 1.9 15.3 12.4 12.3 10.1 3.7 ...</span>
<span class="co">#&gt;  $ length_mm_0       : num  29.6 29.2 29.4 26.8 43.3 78.3 71 70.9 69 48 ...</span>
<span class="co">#&gt;  $ width_mm_0        : num  18.3 17.6 19.7 16 23 37.4 34.4 36.1 36.5 24.5 ...</span>
<span class="co">#&gt;  $ height_mm_0       : num  11.6 10.5 13.5 10 13.3 30.2 21.9 24.5 23.5 16.8 ...</span>
<span class="co">#&gt;  $ date_0            : Date, format: "2013-04-02" "2013-04-02" ...</span>
<span class="co">#&gt;  $ dead_0            : int  0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">#&gt;  $ s_dry_0           : num  -0.729 -0.959 -0.269 -1.373 NA ...</span>
<span class="co">#&gt;  $ s_buoyant_0       : num  NA NA NA NA -1.4 ...</span>
<span class="co">#&gt;  $ s_volume_0        : num  -0.772 -1.008 -0.363 -1.302 -1.885 ...</span>
<span class="co">#&gt;  $ s_width_0         : num  -0.642 -0.875 -0.175 -1.409 -1.989 ...</span>
<span class="co">#&gt;  $ s_height_0        : num  -0.6665 -1.0921 0.0687 -1.2856 -2.1728 ...</span>
<span class="co">#&gt;  $ s_length_0        : num  -0.682 -0.78 -0.731 -1.371 -2.202 ...</span>
<span class="co">#&gt;  $ volume_0          : num  6283 5396 7819 4288 13245 ...</span>
<span class="co">#&gt;  $ corb_density_0    : num  29.6 29.6 29.6 29.6 29.6 29.6 29.6 29.6 29.6 29.6 ...</span>
<span class="co">#&gt;  $ lost_10_or_dead   : num  NA NA NA NA NA 1 1 1 1 1 ...</span>
<span class="co">#&gt;  $ lost_wt_or_dead   : num  NA NA NA NA NA 1 1 1 1 1 ...</span>
<span class="co">#&gt;  $ days              : 'difftime' num  170 170 170 399 ...</span>
<span class="co">#&gt;   ..- attr(*, "units")= chr "days"</span>
<span class="co">#&gt;  $ p_buoyant_weight_d: num  NA NA NA NA NA ...</span>
<span class="co">#&gt;  $ s_buoyant_d       : num  NA NA NA NA NA ...</span>
<span class="co">#&gt;  $ buoyant_weight_g_d: num  NA NA NA NA NA -6.6 -2 -7.5 NA -0.7 ...</span>
<span class="co">#&gt;  $ s_dry_d           : num  0.874 1.381 1.519 1.841 NA ...</span>
<span class="co">#&gt;  $ dry_weight_g_d    : num  1.9 3 3.3 4 NA NA NA NA NA NA ...</span>
<span class="co">#&gt;  $ volume_d          : num  3713 6196 7056 7457 NA ...</span>
<span class="co">#&gt;  $ width_mm_d        : num  2.7 5.4 5.3 9 NA ...</span>
<span class="co">#&gt;  $ height_mm_d       : num  2.4 3.5 3.5 3.9 NA ...</span>
<span class="co">#&gt;  $ length_mm_d       : num  4.4 6.8 5.6 7 NA ...</span>
<span class="co">#&gt;  $ dead              : int  0 0 0 0 NA 0 0 0 1 0 ...</span>
<span class="co">#&gt;  - attr(*, "reshapeWide")=List of 5</span>
<span class="co">#&gt;   ..$ v.names: NULL</span>
<span class="co">#&gt;   ..$ timevar: chr "post"</span>
<span class="co">#&gt;   ..$ idvar  : chr [1:4] "id" "species" "river" "site"</span>
<span class="co">#&gt;   ..$ times  : int [1:2] 1 0</span>
<span class="co">#&gt;   ..$ varying: chr [1:15, 1:2] "dry_weight_g_1" "buoyant_weight_g_1" "length_mm_1" "width_mm_1" ...</span></code></pre></div>
<div id="add-baseline-specimens" class="section level3">
<h3 class="hasAnchor">
<a href="#add-baseline-specimens" class="anchor"></a>Add baseline specimens</h3>
<p>The <code>mussels_wide</code> dataset does not include data on those specimen held out at baseline. The file <code>../extdata/Mussel Metrics Data - Baseline.xlsx</code> contains these data. We add these data to <code>mussels_wide</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">baseline_specimens</span> <span class="op">&lt;-</span> 
  <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span><span class="op">(</span>
    path <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">inputs</span><span class="op">$</span><span class="va">baseline_specimens</span>,
    skip <span class="op">=</span> <span class="fl">1L</span>,
    col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"weight_g_0"</span>, 
                  <span class="st">"length_mm_0"</span>, <span class="st">"width_mm_0"</span>, <span class="st">"height_mm_0"</span>, 
                  <span class="st">"gravid"</span>, <span class="st">"species"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate_at</span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span>, <span class="va">as.numeric</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    buoyant_weight_g_0 <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"A. rav."</span>,
                                 <span class="va">weight_g_0</span>,
                                 <span class="cn">NA_real_</span><span class="op">)</span>,
    dry_weight_g_0 <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"L. fas."</span>,
                             <span class="va">weight_g_0</span>,
                             <span class="cn">NA_real_</span><span class="op">)</span>,
    volume_0 <span class="op">=</span> <span class="va">length_mm_0</span> <span class="op">*</span> <span class="va">width_mm_0</span> <span class="op">*</span> <span class="va">height_mm_0</span>,
    species <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"A. rav."</span>,
                      <span class="st">"A. raveneliana"</span>,
                      <span class="st">"L. fasciola"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">weight_g_0</span>, <span class="op">-</span><span class="va">gravid</span><span class="op">)</span>

<span class="co"># Append to mussels_wide</span>
<span class="va">mussels_wide</span> <span class="op">&lt;-</span>
  <span class="va">mussels_wide</span> <span class="op">%&gt;%</span>
  <span class="fu">bind_rows</span><span class="op">(</span><span class="va">baseline_specimens</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="la-icp-ms-chemistry-data" class="section level2">
<h2 class="hasAnchor">
<a href="#la-icp-ms-chemistry-data" class="anchor"></a>LA-ICP-MS Chemistry data</h2>
<p>The chemical time series data from the LA-ICP-MS runs are contained <code>../extdata/Data/Geochemical Time-Series</code>. Each transect is contained in a separate <code>xlsx</code> file. Some transects are excluded from analysis due to the shape of the transect or other irregularities seen in the scans.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Files to exclude from analyses</span>
<span class="va">exclude_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
   <span class="co"># Horizontal (fly-scanning) transects</span>
   <span class="st">"2-A4-4"</span>, <span class="st">"8-C474-5"</span>, <span class="st">"27-C531-2"</span>, 
   <span class="st">"11-C482-1"</span>, <span class="st">"11-C483-1"</span>,
   
   <span class="co"># Excluding C497 due to unusual structure at the mantle edge</span>
   <span class="st">"16-C497-1"</span>, <span class="st">"16-C497-2"</span>, <span class="st">"16-C497-3"</span>,
   
   <span class="co"># ??? Per notes: This shell does not exist.</span>
   <span class="st">"45-P139-2"</span> 
<span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">valve_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>
  path         <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">inputs</span><span class="op">$</span><span class="va">chemistry_dir</span>,
  full.names   <span class="op">=</span> <span class="cn">TRUE</span>,
  recursive    <span class="op">=</span> <span class="cn">TRUE</span>,
  include.dirs <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># remove exclusions</span>
<span class="va">valve_files</span> <span class="op">&lt;-</span> <span class="va">valve_files</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">valve_files</span>, <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue_collapse.html">glue_collapse</a></span><span class="op">(</span><span class="va">exclude_files</span>, sep <span class="op">=</span> <span class="st">"|"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">raw_data</span>    <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">valve_files</span>, <span class="fu">readxl</span><span class="fu">::</span><span class="va"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">)</span>
<span class="va">sheets</span>      <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_chr</a></span><span class="op">(</span><span class="va">valve_files</span>, <span class="fu">readxl</span><span class="fu">::</span><span class="va"><a href="https://readxl.tidyverse.org/reference/excel_sheets.html">excel_sheets</a></span><span class="op">)</span>
<span class="va">file_names</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">valve_files</span>, <span class="st">"(?&lt;=[1-9]/).*(?=\\.xlsx)"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">raw_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">file_names</span></code></pre></div>
<div id="preimport-consistency-checks" class="section level3">
<h3 class="hasAnchor">
<a href="#preimport-consistency-checks" class="anchor"></a>Preimport consistency checks</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Check sheet names == file name</span>
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">sheets</span><span class="op">)</span> <span class="op">!=</span>  <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">file_names</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"Different # of files and sheets"</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">valve_files</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">file_names</span>, <span class="va">sheets</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt;  [1] "../extdata/Data/Geochemical Time-Series/Drawer 1/5C463.1.xlsx"  </span>
<span class="co">#&gt;  [2] "../extdata/Data/Geochemical Time-Series/Drawer 1/8C472.2.xlsx"  </span>
<span class="co">#&gt;  [3] "../extdata/Data/Geochemical Time-Series/Drawer 3/20-C509-1.xlsx"</span>
<span class="co">#&gt;  [4] "../extdata/Data/Geochemical Time-Series/Drawer 3/26-C530-1.xlsx"</span>
<span class="co">#&gt;  [5] "../extdata/Data/Geochemical Time-Series/Drawer 4/35-P110-2.xlsx"</span>
<span class="co">#&gt;  [6] "../extdata/Data/Geochemical Time-Series/Drawer 5/40-P123-2.xlsx"</span>
<span class="co">#&gt;  [7] "../extdata/Data/Geochemical Time-Series/Drawer 6/51-P157-1.xlsx"</span>
<span class="co">#&gt;  [8] "../extdata/Data/Geochemical Time-Series/Drawer 6/51-P158-1.xlsx"</span>
<span class="co">#&gt;  [9] "../extdata/Data/Geochemical Time-Series/Drawer 6/51-P158-2.xlsx"</span>
<span class="co">#&gt; [10] "../extdata/Data/Geochemical Time-Series/Drawer 6/51-P158-3.xlsx"</span>
<span class="co">#&gt; [11] "../extdata/Data/Geochemical Time-Series/Drawer 6/51-P158-4.xlsx"</span>
<span class="co">#&gt; [12] "../extdata/Data/Geochemical Time-Series/Drawer 6/51-P159-1.xlsx"</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Check that the column names are consistent</span>
<span class="va">colNames</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">raw_data</span>, <span class="va">names</span><span class="op">)</span>
<span class="va">index_nomatch</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_lgl</a></span><span class="op">(</span><span class="va">colNames</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">%in%</span> <span class="va">colNames</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">index_nomatch</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"Some columns don't match"</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">colNames</span><span class="op">[</span><span class="va">index_nomatch</span><span class="op">]</span>
<span class="co">#&gt; named list()</span></code></pre></div>
</div>
<div id="import-chemistry-data" class="section level3">
<h3 class="hasAnchor">
<a href="#import-chemistry-data" class="anchor"></a>Import chemistry data</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">valve_chemistry</span> <span class="op">&lt;-</span> 
  <span class="fu">bind_rows</span><span class="op">(</span><span class="va">raw_data</span>, .id <span class="op">=</span> <span class="st">"file_name"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">file_name</span>, 
    time <span class="op">=</span> <span class="va">ElapsedTime_s</span>, 
    scan_distance <span class="op">=</span><span class="va">`Dist (µm)`</span>,
    note <span class="op">=</span> <span class="va">Notes</span>, 
    <span class="fu">everything</span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span> 

<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">valve_chemistry</span><span class="op">)</span>
<span class="co">#&gt; tibble [116,122 × 28] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#&gt;  $ file_name    : chr [1:116122] "1A1.1" "1A1.1" "1A1.1" "1A1.1" ...</span>
<span class="co">#&gt;  $ time         : num [1:116122] 0 0.576 1.152 1.728 2.304 ...</span>
<span class="co">#&gt;  $ scan_distance: num [1:116122] NA NA NA NA NA NA NA NA NA NA ...</span>
<span class="co">#&gt;  $ note         : chr [1:116122] NA NA NA NA ...</span>
<span class="co">#&gt;  $ Pb208_CPS    : num [1:116122] -15 -15 -15 -15 -15 ...</span>
<span class="co">#&gt;  $ Ca43_CPS     : num [1:116122] -77.6 -177.6 222.4 22.4 -77.6 ...</span>
<span class="co">#&gt;  $ Mg_ppm_m24   : num [1:116122] -5292 5249 1344 23380 474 ...</span>
<span class="co">#&gt;  $ Mg_ppm_m25   : num [1:116122] 15439 2124 -1697 130057 -16303 ...</span>
<span class="co">#&gt;  $ Cr_ppm_m53   : num [1:116122] 742 -2155 -1249 26967 3579 ...</span>
<span class="co">#&gt;  $ Mn_ppm_m55   : num [1:116122] 3190 582 555 8285 269 ...</span>
<span class="co">#&gt;  $ Fe_ppm_m57   : num [1:116122] -147387 7853 -24038 -239015 94293 ...</span>
<span class="co">#&gt;  $ Co_ppm_m59   : num [1:116122] 104.5 -269.4 -36.5 -362.9 -256 ...</span>
<span class="co">#&gt;  $ Ni_ppm_m60   : num [1:116122] -4285 -555 -609 46288 3253 ...</span>
<span class="co">#&gt;  $ Cu_ppm_m63   : num [1:116122] 61 593 -700 -4711 709 ...</span>
<span class="co">#&gt;  $ Cu_ppm_m65   : num [1:116122] -395 -173 -340 1370 -395 ...</span>
<span class="co">#&gt;  $ Zn_ppm_m66   : num [1:116122] 1108 -768 1614 26001 -1758 ...</span>
<span class="co">#&gt;  $ Zn_ppm_m68   : num [1:116122] -44179 2512 2351 66711 1588 ...</span>
<span class="co">#&gt;  $ As_ppm_m75   : num [1:116122] 2379 -3342 1970 -8265 4387 ...</span>
<span class="co">#&gt;  $ Se82_CPS     : num [1:116122] -0.413 -280.413 -40.413 -40.414 79.596 ...</span>
<span class="co">#&gt;  $ Kr83_CPS     : num [1:116122] -106.3 53.7 -186.3 -26.3 53.7 ...</span>
<span class="co">#&gt;  $ Sr_ppm_m88   : num [1:116122] 1.345 0.588 -0.469 -4.668 1.345 ...</span>
<span class="co">#&gt;  $ Mo_ppm_m95   : num [1:116122] 5.36 2.34 -1.87 -18.6 5.36 ...</span>
<span class="co">#&gt;  $ Cd_ppm_m111  : num [1:116122] -4021 0 1404 0 -4022 ...</span>
<span class="co">#&gt;  $ Sn_ppm_m118  : num [1:116122] 333 -1293 -116 4557 -490 ...</span>
<span class="co">#&gt;  $ Ba_ppm_m138  : num [1:116122] 3.05 1.33 89.8 -10.57 -517.49 ...</span>
<span class="co">#&gt;  $ Hg_ppm_m202  : num [1:116122] -1383 -370 295 6670 -309 ...</span>
<span class="co">#&gt;  $ Pb_ppm_m208  : num [1:116122] 165.9 72.6 -58 -576.8 166.2 ...</span>
<span class="co">#&gt;  $ U_ppm_m238   : num [1:116122] 2.668 1.166 -0.932 -9.264 2.669 ...</span></code></pre></div>
</div>
<div id="post-import-consistency-checks" class="section level3">
<h3 class="hasAnchor">
<a href="#post-import-consistency-checks" class="anchor"></a>Post-import consistency checks</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hold</span> <span class="op">&lt;-</span> <span class="va">valve_chemistry</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">scan_distance</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">file_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    x_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.576</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>,
    x_dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.88</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">scan_distance</span><span class="op">)</span><span class="op">)</span>,
    has_on <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">note</span>, <span class="st">"[Oo]n"</span><span class="op">)</span>,
    has_off <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">note</span>, <span class="st">"[Oo]ff"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># Are all the elapsed times the same within 0.01</span>
<span class="va">hold</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    same_time_diffs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="op">(</span><span class="va">x_time</span> <span class="op">-</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">x_time</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&amp;</span> 
                           <span class="va">x_time</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;</span> <span class="op">(</span><span class="va">x_time</span> <span class="op">+</span> <span class="fl">0.01</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">same_time_diffs</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="op">{</span><span class="kw">if</span><span class="op">(</span><span class="va">.</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"not all the elapsed time are within 0.01"</span><span class="op">)</span><span class="op">}</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>

<span class="co"># Are all the scan distances within 0.01?</span>
<span class="va">hold</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    same_dist_diffs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="op">(</span><span class="va">x_dist</span> <span class="op">-</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">x_dist</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&amp;</span> 
                           <span class="va">x_dist</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="op">(</span><span class="va">x_dist</span> <span class="op">+</span> <span class="fl">0.01</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">same_dist_diffs</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="op">{</span><span class="kw">if</span><span class="op">(</span><span class="va">.</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"not all the scan distances are within 0.01"</span><span class="op">)</span><span class="op">}</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>

<span class="co">## Do all files have an "on" and "off" indicator in the note field?</span>
<span class="va">hold</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    n_on    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">has_on</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    n_off   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">has_off</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    any_on  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">has_on</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    any_off <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">has_off</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span>
    <span class="op">!</span><span class="va">any_on</span> <span class="op">|</span> <span class="op">!</span><span class="va">any_off</span> <span class="op">|</span> <span class="va">n_on</span> <span class="op">&gt;</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">n_off</span> <span class="op">&gt;</span> <span class="fl">1</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="op">{</span><span class="kw">if</span><span class="op">(</span><span class="va">.</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"not all files have on and off indicators"</span><span class="op">)</span><span class="op">}</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span></code></pre></div>
</div>
<div id="prepare-chemistry-data-for-merging-with-valve-measurements" class="section level3">
<h3 class="hasAnchor">
<a href="#prepare-chemistry-data-for-merging-with-valve-measurements" class="anchor"></a>Prepare chemistry data for merging with valve measurements</h3>
<p>Next, we identify the laser on/off points which were manually annotated in the <code>xlsx</code> files and prepare the <code>valve_chemistry</code> data for further processing. The result is written to <code>../data/valve_chemistry.rds</code></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">valve_chemistry</span> <span class="op">&lt;-</span>
  <span class="va">valve_chemistry</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">file_name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Identify laser on/off points</span>
  <span class="fu">mutate</span><span class="op">(</span>
    is_laser_on  <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">note</span>, <span class="st">"[Oo]n$"</span><span class="op">)</span>,
    is_laser_off <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">note</span>, <span class="st">"[Oo]ff$"</span><span class="op">)</span>,
    is_laser_on  <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">is_laser_on</span><span class="op">)</span>, <span class="cn">FALSE</span>, <span class="va">is_laser_on</span><span class="op">)</span>,
    is_laser_off <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">is_laser_off</span><span class="op">)</span>, <span class="cn">FALSE</span>, <span class="va">is_laser_off</span><span class="op">)</span>,
    on_row       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">is_laser_on</span><span class="op">)</span>,
    off_row      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">is_laser_off</span><span class="op">)</span>,
    last_val_row <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Ca43_CPS</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,
    rn           <span class="op">=</span> <span class="fu">row_number</span><span class="op">(</span><span class="op">)</span>,
    <span class="co"># scan_distance is NA before the on_row, add it back</span>
    scan_distance  <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">scan_distance</span><span class="op">)</span>, 
      <span class="op">-</span><span class="fl">2.881</span> <span class="op">*</span> <span class="op">(</span><span class="va">on_row</span> <span class="op">-</span> <span class="va">rn</span><span class="op">)</span> ,
      <span class="va">scan_distance</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Remove rows at end of each file with no data</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">rn</span> <span class="op">&lt;=</span> <span class="va">last_val_row</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="op">-</span><span class="va">is_laser_on</span>, <span class="op">-</span><span class="va">is_laser_off</span>, <span class="op">-</span><span class="va">rn</span>, <span class="op">-</span><span class="va">on_row</span>, <span class="op">-</span><span class="va">off_row</span>, <span class="op">-</span><span class="va">last_val_row</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>file_name <span class="op">=</span> <span class="fu"><a href="../reference/clean_ids.html">clean_ids</a></span><span class="op">(</span><span class="va">file_name</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">file_name</span>, sep <span class="op">=</span> <span class="st">"-"</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"transect"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span>, distance <span class="op">=</span> <span class="va">scan_distance</span>, <span class="fu">everything</span><span class="op">(</span><span class="op">)</span>, <span class="op">-</span><span class="va">time</span>, <span class="op">-</span><span class="va">note</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">valve_chemistry</span>, file <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">outputs</span><span class="op">$</span><span class="va">chemistry</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="lower-limit-of-detection-data" class="section level2">
<h2 class="hasAnchor">
<a href="#lower-limit-of-detection-data" class="anchor"></a>Lower limit of detection data</h2>
<p>The excel file `<code>was prepared by the UT LA-ICP-MS lab and contains lower limit of detection information data for elemental concentrations. Here, we use his data to find the average per element per drawer and write the results to</code>../data/lower_detection_limits.rds`.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lod</span> <span class="op">&lt;-</span>
  <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span>
   path <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">inputs</span><span class="op">$</span><span class="va">lod</span>,
   sheet <span class="op">=</span> <span class="st">"Without Stats"</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    standard <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">Comments</span>, <span class="st">"614|612"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">standard</span>, <span class="va">Date</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    standard_run <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>,
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">Date</span>, <span class="op">-</span><span class="va">Time</span>, <span class="op">-</span><span class="st">"Duration(s)"</span>, <span class="op">-</span><span class="va">DateTime</span>, <span class="op">-</span><span class="va">Comments</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Exclude</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span>
    drawer <span class="op">=</span> <span class="va">Drawer</span>, output <span class="op">=</span> <span class="va">Output</span>, source_file <span class="op">=</span> <span class="va">`Source file`</span>, 
    <span class="va">standard</span>, <span class="va">standard_run</span>, <span class="fu">matches</span><span class="op">(</span><span class="st">"CPS|ppm"</span><span class="op">)</span>
  <span class="op">)</span>  <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span>
    key <span class="op">=</span> <span class="st">"key"</span>, value <span class="op">=</span> <span class="st">"value"</span>, 
    <span class="op">-</span><span class="va">drawer</span>, <span class="op">-</span><span class="va">output</span>, <span class="op">-</span><span class="va">source_file</span>, <span class="op">-</span><span class="va">standard</span>, <span class="op">-</span><span class="va">standard_run</span>,
     na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    drawer       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">drawer</span>, <span class="st">"D"</span><span class="op">)</span><span class="op">)</span>,
    measure      <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">key</span>, <span class="st">"_(Int2SE|LOD)$"</span><span class="op">)</span>, <span class="st">"_"</span>, <span class="st">""</span><span class="op">)</span>,
    measure      <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">measure</span><span class="op">)</span>, <span class="st">"raw"</span>, <span class="va">measure</span><span class="op">)</span>,
    element      <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="va">key</span>, <span class="st">"_(Int2SE|LOD)$"</span>, <span class="st">""</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span>
    <span class="va">drawer</span>, <span class="va">standard</span>, <span class="va">output</span>, <span class="va">source_file</span>, <span class="va">standard_run</span>, <span class="va">element</span>, <span class="va">measure</span>, <span class="va">value</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Just keep the lower limit of detection</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">measure</span> <span class="op">==</span> <span class="st">"LOD"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">element</span>, <span class="va">drawer</span>, <span class="va">standard</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    lod_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">element</span>, <span class="va">drawer</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    lod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">lod_mean</span><span class="op">)</span>
  <span class="op">)</span> 
<span class="co">#&gt; `summarise()` regrouping output by 'element', 'drawer' (override with `.groups` argument)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'element' (override with `.groups` argument)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">lod</span>, file <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">outputs</span><span class="op">$</span><span class="va">lod</span><span class="op">)</span></code></pre></div>
</div>
<div id="measurement-data" class="section level2">
<h2 class="hasAnchor">
<a href="#measurement-data" class="anchor"></a>Measurement Data</h2>
<p>This section loads and saves measurements of valves registered by using a ruler to measure distance between points along each transect manually identified as key transition points a valve’s anatomy (e.g., the transition between nacre and prismatic layer).</p>
<p>Each sheet of <code>../extdata/Data/Bivalve Transect Datums.xlsx</code> cooresponds to a drawer from the LA-ICP-MS processing. T</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sheets</span>        <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/excel_sheets.html">excel_sheets</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">inputs</span><span class="op">$</span><span class="va">meausurements</span><span class="op">)</span>
<span class="va">import_sheets</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>  <span class="co">## Note excluding Drawer 7 (see below)</span>

<span class="va">valve_measurements</span> <span class="op">&lt;-</span> 
  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span>
    .x <span class="op">=</span> <span class="va">sheets</span><span class="op">[</span><span class="va">import_sheets</span><span class="op">]</span>, 
    .f <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/read_measurements_sheet.html">read_measurements_sheet</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">inputs</span><span class="op">$</span><span class="va">meausurements</span>, <span class="va">.x</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="../reference/munge_measurements.html">munge_measurements</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  
  <span class="fu">bind_rows</span><span class="op">(</span>
    <span class="co">## Drawer 7 import ####</span>
    <span class="co"># the structure of Drawer is slightly different from the others and </span>
    <span class="co"># requires special handling</span>
    
    <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span>
      path <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">inputs</span><span class="op">$</span><span class="va">meausurements</span>,
      sheet <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"^PAT"</span>, <span class="va">`...2`</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>file_name <span class="op">=</span> <span class="va">`...2`</span>, <span class="fu">matches</span><span class="op">(</span><span class="st">"Length"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">`Length from 1 to 2 (mm)`</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">mutate</span><span class="op">(</span>
        file_name <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">file_name</span>, <span class="st">"^PAT:"</span><span class="op">)</span>,
        drawer    <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="../reference/munge_measurements.html">munge_measurements</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  
  <span class="co">## HARD CODES #####</span>
  <span class="fu">add_row</span><span class="op">(</span>
    <span class="co"># Added 2018-11-10:</span>
    <span class="co"># 12-C485-2 is missing the measurement from 1 to 4 (the prismatic/periostracum </span>
    <span class="co"># transition). The bivalve datum spreadsheet notes: This shell is broken </span>
    <span class="co"># and does not have a point 4 before the break. Setting this distance to 10</span>
    <span class="co"># samples before the transition to point 5</span>
    file_name <span class="op">=</span> <span class="st">"12-C485-2"</span>,
    drawer    <span class="op">=</span> <span class="fl">2</span>,
    from      <span class="op">=</span> <span class="st">"1"</span>,
    to        <span class="op">=</span> <span class="st">"4"</span>,
    distance  <span class="op">=</span> <span class="fl">18.275</span> <span class="op">-</span> <span class="op">(</span><span class="fl">10</span> <span class="op">*</span> <span class="fl">.02881</span><span class="op">)</span>
  <span class="op">)</span>  <span class="op">%&gt;%</span>
  
  <span class="fu">mutate</span><span class="op">(</span>
    <span class="co"># Added 2018-11-10:</span>
    <span class="co"># The units of 1 to 5 measurement for 2A6.1 are off by 10^3</span>
    distance <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">file_name</span> <span class="op">==</span> <span class="st">"2A6.1"</span> <span class="op">&amp;</span> <span class="va">to</span> <span class="op">==</span> <span class="fl">5</span>, <span class="va">distance</span><span class="op">/</span><span class="fl">1000</span>, <span class="va">distance</span><span class="op">)</span>
    
    <span class="co"># Added 2018-11-10:</span>
    <span class="co"># Removed (at a later date)</span>
    <span class="co"># if the distance from 1 to 2 is 0 then there is no gap from laser on to</span>
    <span class="co"># inner epoxy, but this leads to non-unique breaks in the create_layer_idFUN</span>
    <span class="co"># function ==&gt; adding small gap</span>
    <span class="co"># distance = case_when(</span>
    <span class="co">#   to == "2" &amp; distance == 0 ~ -0.02881 ,</span>
    <span class="co">#   TRUE ~ distance</span>
    <span class="co"># )</span>
    
  <span class="op">)</span> <span class="op">%&gt;%</span>
  
  <span class="co">## END HARD CODES ##</span>
  
  <span class="co"># Remove exclusions </span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">file_name</span> <span class="op">%in%</span> <span class="va">exclude_files</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">distance</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>file_name <span class="op">=</span> <span class="fu"><a href="../reference/clean_ids.html">clean_ids</a></span><span class="op">(</span><span class="va">file_name</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html">separate</a></span><span class="op">(</span><span class="va">file_name</span>, sep <span class="op">=</span> <span class="st">"-"</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"transect"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">drawer</span>, <span class="va">id</span>, <span class="va">transect</span><span class="op">)</span> <span class="op">%&gt;%</span>
  
  <span class="co"># put distance in same units as chemistry data</span>
  <span class="fu">mutate</span><span class="op">(</span>distance <span class="op">=</span> <span class="va">distance</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">arrange</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span>, <span class="va">from</span>, <span class="va">to</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  
  <span class="co"># 2018-11-11: remove cases where to == "2" and distance == 0</span>
  <span class="co"># These indicate records without a nacre measurement and interfere with the </span>
  <span class="co"># processes below</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">to</span> <span class="op">==</span> <span class="st">"2"</span> <span class="op">&amp;</span> <span class="va">distance</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  
  <span class="co"># Create the patterns of layer transitions</span>
  <span class="fu">mutate</span><span class="op">(</span>
    <span class="co"># NOTE: this works because all(from == "1") == TRUE; this could be generalized to a </span>
    <span class="co"># data format where from varies</span>
    layer_transition <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span>
      <span class="va">to</span> <span class="op">==</span> <span class="st">"2"</span> <span class="op">~</span> <span class="st">"ipx_ncr"</span>,
      <span class="co"># Handle cases where transect does not cross nacre</span>
      <span class="va">to</span> <span class="op">==</span> <span class="st">"3"</span> <span class="op">&amp;</span>   <span class="st">"2"</span> <span class="op">%in%</span> <span class="va">to</span>  <span class="op">~</span> <span class="st">"ncr_psm"</span>,
      <span class="va">to</span> <span class="op">==</span> <span class="st">"3"</span> <span class="op">&amp;</span> <span class="op">!</span><span class="op">(</span><span class="st">"2"</span> <span class="op">%in%</span> <span class="va">to</span><span class="op">)</span> <span class="op">~</span> <span class="st">"ipx_psm"</span>,
      <span class="va">to</span> <span class="op">==</span> <span class="st">"4"</span> <span class="op">~</span> <span class="st">"psm_pio"</span>,
      <span class="va">to</span> <span class="op">==</span> <span class="st">"5"</span> <span class="op">~</span> <span class="st">"pio_opx"</span>,
      <span class="va">to</span> <span class="op">==</span> <span class="st">"6"</span> <span class="op">~</span> <span class="st">"opx_off"</span>
    <span class="op">)</span>,
    annuli_transition    <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">to</span>, <span class="st">"[A-Z]"</span><span class="op">)</span>,
    is_layer  <span class="op">=</span> <span class="op">(</span><span class="va">to</span> <span class="op">%in%</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span>,
    is_annuli <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">to</span>, <span class="st">"[A-Z]"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  
  <span class="co"># Add a record for laser on -&gt; inner epoxy</span>
  <span class="fu">mutate</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>
    .x <span class="op">=</span> <span class="va">data</span>, 
    .f <span class="op">=</span> <span class="op">~</span> <span class="va">.x</span> <span class="op">%&gt;%</span>
         <span class="fu">add_row</span><span class="op">(</span>
           from     <span class="op">=</span> <span class="st">"1"</span>,
           to       <span class="op">=</span> <span class="st">"1"</span>,
           distance <span class="op">=</span> <span class="fl">0</span>,
           layer_transition <span class="op">=</span> <span class="st">"on_ipx"</span>,
           annuli_transition <span class="op">=</span> <span class="cn">NA_character_</span>,
           is_layer   <span class="op">=</span> <span class="cn">TRUE</span>,
           is_annuli  <span class="op">=</span> <span class="cn">FALSE</span>,
           .before   <span class="op">=</span> <span class="fl">1</span> <span class="op">)</span>
  <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; New names:</span>
<span class="co">#&gt; * `` -&gt; ...4</span>
<span class="co">#&gt; New names:</span>
<span class="co">#&gt; * `` -&gt; ...4</span>
<span class="co">#&gt; New names:</span>
<span class="co">#&gt; * `` -&gt; ...4</span>
<span class="co">#&gt; New names:</span>
<span class="co">#&gt; * `` -&gt; ...4</span>
<span class="co">#&gt; New names:</span>
<span class="co">#&gt; * `` -&gt; ...4</span>
<span class="co">#&gt; New names:</span>
<span class="co">#&gt; * `` -&gt; ...4</span>
<span class="co">#&gt; New names:</span>
<span class="co">#&gt; * `` -&gt; ...1</span>
<span class="co">#&gt; * `` -&gt; ...2</span>
<span class="co">#&gt; * `` -&gt; ...3</span>
<span class="co">#&gt; * `` -&gt; ...4</span>
<span class="co">#&gt; * `` -&gt; ...5</span>
<span class="co">#&gt; * ...</span>
<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(data)`</span></code></pre></div>
<div id="measurements-consistency-checks" class="section level3">
<h3 class="hasAnchor">
<a href="#measurements-consistency-checks" class="anchor"></a>Measurements consistency checks</h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Which id-transect have missing layer transition measurments?</span>

<span class="va">valid_patterns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"on_ipx:(ipx_ncr:ncr_psm|ipx_psm):psm_pio:pio_opx:opx_off"</span><span class="op">)</span>

<span class="va">valve_measurements</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">is_layer</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    meas_pattern <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">layer_transition</span>, collapse <span class="op">=</span> <span class="st">":"</span><span class="op">)</span>,
    has_valid_pattern <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">meas_pattern</span>, <span class="va">valid_patterns</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">has_valid_pattern</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'id' (override with `.groups` argument)</span>
<span class="co">#&gt; # A tibble: 0 x 4</span>
<span class="co">#&gt; # Groups:   id [0]</span>
<span class="co">#&gt; # … with 4 variables: id &lt;chr&gt;, transect &lt;chr&gt;, meas_pattern &lt;chr&gt;,</span>
<span class="co">#&gt; #   has_valid_pattern &lt;lgl&gt;</span></code></pre></div>
<p>The resulting dataset identifies the distances between layer transitions (e.g. epoxy to nacre, nacre to prismatic layer, etc) along each LA-ICP-MS transect.</p>
<p>The values in the <code>from</code> and <code>to</code> columns correspond to the following points on a valve, starting for the inner side of the value:</p>
<p>Numbered datums</p>
<ul>
<li>1 = laser on point in epoxy</li>
<li>2 = interior shell/epoxy contact</li>
<li>3 = nacreous/prismatic layer contact</li>
<li>4 = prismatic/periostracum contact</li>
<li>5 = periostracum/epoxy contact</li>
<li>6 = laser off point in epoxy</li>
</ul>
<p>Alphabetical datums</p>
<ul>
<li>A = youngest (last) annuli</li>
<li>B = next youngest annuli</li>
<li>C = next youngest annuli</li>
<li>D = etc</li>
<li>A’ = same annuli as A, but next transect toward umbo</li>
<li>B’ = same annuli as B, but next transect toward umbo</li>
<li>C’ = etc.</li>
<li>A" = same annuli as A and A’, but next transect toward umbo</li>
<li>B" = etc.</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">valve_measurements</span><span class="op">)</span>
<span class="co">#&gt; tibble [2,181 × 10] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#&gt;  $ drawer           : num [1:2181] 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;  $ id               : chr [1:2181] "A1" "A1" "A1" "A1" ...</span>
<span class="co">#&gt;  $ transect         : chr [1:2181] "1" "1" "1" "1" ...</span>
<span class="co">#&gt;  $ from             : chr [1:2181] "1" "1" "1" "1" ...</span>
<span class="co">#&gt;  $ to               : chr [1:2181] "1" "2" "3" "4" ...</span>
<span class="co">#&gt;  $ distance         : num [1:2181] 0 75.7 911.2 1202.9 1253 ...</span>
<span class="co">#&gt;  $ layer_transition : chr [1:2181] "on_ipx" "ipx_ncr" "ncr_psm" "psm_pio" ...</span>
<span class="co">#&gt;  $ annuli_transition: chr [1:2181] NA NA NA NA ...</span>
<span class="co">#&gt;  $ is_layer         : logi [1:2181] TRUE TRUE TRUE TRUE TRUE TRUE ...</span>
<span class="co">#&gt;  $ is_annuli        : logi [1:2181] FALSE FALSE FALSE FALSE FALSE FALSE ...</span>

<span class="co">## Save measurements ####</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">valve_measurements</span>, file <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">outputs</span><span class="op">$</span><span class="va">measurements</span><span class="op">)</span></code></pre></div>
</div>
</div>
</div>
<div id="linking-anatomical-location-to-chemistry" class="section level1">
<h1 class="hasAnchor">
<a href="#linking-anatomical-location-to-chemistry" class="anchor"></a>Linking Anatomical Location to Chemistry</h1>
<p>This section joins the <code>valve_chemistry</code> data with the <code>valve_measurements</code> data by <code>id/transect</code>.</p>
<div id="checks-before-linking" class="section level2">
<h2 class="hasAnchor">
<a href="#checks-before-linking" class="anchor"></a>Checks before linking</h2>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">chem_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">valve_chemistry</span><span class="op">$</span><span class="va">id</span>, <span class="va">valve_chemistry</span><span class="op">$</span><span class="va">transect</span><span class="op">)</span><span class="op">)</span>
<span class="va">meas_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">valve_measurements</span><span class="op">$</span><span class="va">id</span>, <span class="va">valve_measurements</span><span class="op">$</span><span class="va">transect</span><span class="op">)</span><span class="op">)</span>

<span class="co">## IDs founds in chemistry data but not in measurement</span>
<span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="va">chem_ids</span>, <span class="va">meas_ids</span><span class="op">)</span>
<span class="co">#&gt; character(0)</span>
<span class="co">## IDs founds in measurement data but not in chemistry</span>
<span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="va">meas_ids</span>, <span class="va">chem_ids</span><span class="op">)</span>
<span class="co">#&gt; [1] "P1592"</span>

<span class="co">## IDs in mussels_wide but not in valve_chemistry</span>
<span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="va">mussels_wide</span><span class="op">$</span><span class="va">id</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">valve_chemistry</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "C497" "C527" "P102" "P138"</span>
<span class="co"># C497 was excluded</span>
<span class="co"># Not sure about the others</span>

<span class="co">##  IDs in valve_chemistry but not in mussels_wide</span>
<span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">valve_chemistry</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="va">mussels_wide</span><span class="op">$</span><span class="va">id</span><span class="op">)</span> 
<span class="co">#&gt; character(0)</span>
<span class="co"># most (all?) of these are baseline IDs</span></code></pre></div>
</div>
<div id="perform-join" class="section level2">
<h2 class="hasAnchor">
<a href="#perform-join" class="anchor"></a>Perform join</h2>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">valve_data</span> <span class="op">&lt;-</span> 
  <span class="fu">inner_join</span><span class="op">(</span>
    <span class="va">valve_chemistry</span> <span class="op">%&gt;%</span>
      <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">mutate</span><span class="op">(</span>obs <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">distance</span>, <span class="op">-</span><span class="fu">contains</span><span class="op">(</span><span class="st">"CPS"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span>.key <span class="op">=</span> <span class="st">"chemistry"</span><span class="op">)</span>,
    <span class="va">valve_chemistry</span> <span class="op">%&gt;%</span>
      <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">mutate</span><span class="op">(</span>obs <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span>, <span class="va">distance</span>, <span class="va">obs</span>, <span class="fu">contains</span><span class="op">(</span><span class="st">"CPS"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span>.key <span class="op">=</span> <span class="st">"distance"</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"transect"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  
  <span class="co">## Link chemistry &amp; datum measurements ####</span>
  <span class="fu">inner_join</span><span class="op">(</span>
    <span class="va">valve_measurements</span> <span class="op">%&gt;%</span>
      <span class="co"># dplyr::select(-drawer) %&gt;%</span>
      <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span>.key <span class="op">=</span> <span class="st">"measures"</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"transect"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="co">#&gt; Warning: `.key` is deprecated</span>

<span class="co">#&gt; Warning: `.key` is deprecated</span>

<span class="co">#&gt; Warning: `.key` is deprecated</span></code></pre></div>
</div>
<div id="add-lod-information" class="section level2">
<h2 class="hasAnchor">
<a href="#add-lod-information" class="anchor"></a>Add LOD information</h2>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">valve_data</span> <span class="op">&lt;-</span> 
  <span class="va">valve_data</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    drawer <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">measures</span>, <span class="op">~</span> <span class="va">.x</span><span class="op">$</span><span class="va">drawer</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span>
    <span class="va">lod</span> <span class="op">%&gt;%</span>
      <span class="fu">group_by</span><span class="op">(</span><span class="va">drawer</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span>.key <span class="op">=</span> <span class="st">"lod"</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="st">"drawer"</span>
  <span class="op">)</span> 
<span class="co">#&gt; Warning: `.key` is deprecated</span></code></pre></div>
</div>
<div id="align-anatomy-with-chemistry" class="section level2">
<h2 class="hasAnchor">
<a href="#align-anatomy-with-chemistry" class="anchor"></a>Align anatomy with chemistry</h2>
<p>This section tests various methods of identifying reference points from which to calculate distances. We then select the best method for each transect as the one with the smallest mean squared error (difference between the transect distance measured manually and the distance between the inner and outer reference points determined by each method).</p>
<div id="alignment-methods" class="section level3">
<h3 class="hasAnchor">
<a href="#alignment-methods" class="anchor"></a>Alignment Methods</h3>
<p>The following list specifies the methods used to find alignment. Each element of the list is a different method or different arguments for a method. For example, method <code>A</code> uses the epoxy on (<code>on_</code>) transition point as the reference transition point and then uses that point as the “zero point” from which to align the anatomy. Method <code>B</code> uses the inner expoxy transition point (<code>ipx_</code>) as the reference transition point, then from there identifies the zero point using the <code>id_changepoint</code> function which based on the <code><a href="https://rdrr.io/pkg/changepoint/man/cpt.meanvar.html">changepoint::cpt.meanvar</a></code> function <span class="citation">(Killick and Eckley 2014)</span>. Except for method <code>A</code>, the methods are paired: one to identify the inner edge of the valve, the another to identify the outer edge. The pairs are <code>B-C</code>, <code>D-E</code>, etc.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Specifications for the alignment methods to test ####</span>
<span class="va">test_methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="st">"on_"</span>,
    zf <span class="op">=</span> <span class="va">identity</span>,
    zfa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>,
  B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="st">"ipx_"</span>,
    zf <span class="op">=</span> <span class="va">id_changepoint</span>,
    zfa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>.var <span class="op">=</span> <span class="st">"Ca43_CPS"</span>, .use_up_to_row <span class="op">=</span> <span class="fl">150</span>, .method <span class="op">=</span> <span class="st">"AMOC"</span>,
               .outer <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="op">)</span>,
  C <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="st">"_opx"</span>,
    zf <span class="op">=</span> <span class="va">id_changepoint</span>,
    zfa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>.var <span class="op">=</span> <span class="st">"Ca43_CPS"</span>, .use_up_to_row <span class="op">=</span> <span class="fl">150</span>, .method <span class="op">=</span> <span class="st">"AMOC"</span>, 
               .outer <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span>,
  D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="st">"ipx_"</span>,
    zf <span class="op">=</span> <span class="va">id_changepoint</span>,
    zfa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>.var <span class="op">=</span> <span class="st">"Pb208_CPS"</span>, .use_up_to_row <span class="op">=</span> <span class="fl">150</span>, .method <span class="op">=</span> <span class="st">"AMOC"</span>, 
               .outer <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="op">)</span>,
  E <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="st">"_opx"</span>,
    zf <span class="op">=</span> <span class="va">id_changepoint</span>,
    zfa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>.var <span class="op">=</span> <span class="st">"Pb208_CPS"</span>, .use_up_to_row <span class="op">=</span> <span class="fl">150</span>, .method <span class="op">=</span> <span class="st">"AMOC"</span>,
               .outer <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span>,
  `F` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="st">"ipx_"</span>,
    zf <span class="op">=</span> <span class="va">pbca_minpoint</span>,
    zfa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>.use_up_to_row <span class="op">=</span> <span class="fl">150</span>, .outer <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="op">)</span>,
  G <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="st">"_opx"</span>,
    zf <span class="op">=</span> <span class="va">pbca_minpoint</span>,
    zfa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>.use_up_to_row <span class="op">=</span> <span class="fl">150</span>, .outer <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span>,
  H <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="st">"ipx_"</span>,
    zf <span class="op">=</span> <span class="va">maxpoint</span>,
    zfa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>.var <span class="op">=</span> <span class="st">"ratio"</span>, .use_up_to_row <span class="op">=</span> <span class="fl">150</span>, .outer <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="op">)</span>,
  I <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="st">"_opx"</span>,
    zf <span class="op">=</span> <span class="va">maxpoint</span>,
    zfa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>.var <span class="op">=</span> <span class="st">"ratio"</span>, .use_up_to_row <span class="op">=</span> <span class="fl">150</span>, .outer <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span>,
  J <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="st">"ipx_"</span>,
    zf <span class="op">=</span> <span class="va">maxpoint</span>,
    zfa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>.var <span class="op">=</span> <span class="st">"ratio"</span>, .use_up_to_row <span class="op">=</span> <span class="fl">150</span>,
               .threshold <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">.95</span><span class="op">)</span>, .outer <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="op">)</span>,
  K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="st">"_opx"</span>,
    zf <span class="op">=</span> <span class="va">maxpoint</span>,
    zfa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>.var <span class="op">=</span> <span class="st">"ratio"</span>, .use_up_to_row <span class="op">=</span> <span class="fl">150</span>, 
               .threshold <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">.95</span><span class="op">)</span>, .outer <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span>,
  L <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="st">"ipx_"</span>,
    zf <span class="op">=</span> <span class="va">maxpoint</span>,
    zfa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>.var <span class="op">=</span> <span class="st">"Pb208_CPS"</span>, .use_up_to_row <span class="op">=</span> <span class="fl">150</span>, .threshold <span class="op">=</span> <span class="fl">1000</span>,
               .outer <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="op">)</span>,
  M <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    rt <span class="op">=</span> <span class="st">"_opx"</span>,
    zf <span class="op">=</span> <span class="va">maxpoint</span>,
    zfa <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>.var <span class="op">=</span> <span class="st">"Pb208_CPS"</span>, .use_up_to_row <span class="op">=</span> <span class="fl">150</span>, .threshold <span class="op">=</span> <span class="fl">1000</span>, 
               .outer <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>We apply all these methods:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">method_tests</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2_dfr</a></span><span class="op">(</span>
  .x <span class="op">=</span> <span class="va">test_methods</span>, 
  .y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">test_methods</span><span class="op">)</span>, 
  .f <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/apply_ref_method.html">apply_ref_method</a></span><span class="op">(</span><span class="va">valve_data</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">lod</span><span class="op">)</span>, <span class="va">.x</span>, <span class="va">.y</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>idref_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">idref_method</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span>

<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span>

<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span>

<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span>

<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span>

<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span>

<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span>

<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span>

<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span>

<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span>

<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning in max(pracma::findpeaks(dir(Pb208_CPS[nn &lt; .use_up_to_row]), threshold</span>
<span class="co">#&gt; = .threshold)[, : no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning in max(pracma::findpeaks(dir(Pb208_CPS[nn &lt; .use_up_to_row]), threshold</span>
<span class="co">#&gt; = .threshold)[, : no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning in max(pracma::findpeaks(dir(Pb208_CPS[nn &lt; .use_up_to_row]), threshold</span>
<span class="co">#&gt; = .threshold)[, : no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning in max(pracma::findpeaks(dir(Pb208_CPS[nn &lt; .use_up_to_row]), threshold</span>
<span class="co">#&gt; = .threshold)[, : no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning in max(pracma::findpeaks(dir(Pb208_CPS[nn &lt; .use_up_to_row]), threshold</span>
<span class="co">#&gt; = .threshold)[, : no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning in max(pracma::findpeaks(dir(Pb208_CPS[nn &lt; .use_up_to_row]), threshold</span>
<span class="co">#&gt; = .threshold)[, : no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning in max(pracma::findpeaks(dir(Pb208_CPS[nn &lt; .use_up_to_row]), threshold</span>
<span class="co">#&gt; = .threshold)[, : no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning in max(pracma::findpeaks(dir(Pb208_CPS[nn &lt; .use_up_to_row]), threshold</span>
<span class="co">#&gt; = .threshold)[, : no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `cpt`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `cpt` is `max(...)`.</span>
<span class="co">#&gt; Warning: Problem with `mutate()` input `distance`.</span>
<span class="co">#&gt; ℹ no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; ℹ Input `distance` is `purrr::map(...)`.</span>
<span class="co">#&gt; Warning in max(pracma::findpeaks(dir(Pb208_CPS[nn &lt; .use_up_to_row]), threshold</span>
<span class="co">#&gt; = .threshold)[, : no non-missing arguments to max; returning -Inf</span>
<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span></code></pre></div>
<p>We then calculate the lengths of each transect within a valve as measured “by hand”.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">valve_lengths</span> <span class="op">&lt;-</span> 
  <span class="va">valve_measurements</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"ipx_"</span>, <span class="va">layer_transition</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"opx_"</span>, <span class="va">layer_transition</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    on_opx_distance <span class="op">=</span> <span class="va">distance</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"_opx"</span>, <span class="va">layer_transition</span><span class="op">)</span><span class="op">]</span>,
    on_ipx_distance <span class="op">=</span> <span class="va">distance</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"ipx_"</span>, <span class="va">layer_transition</span><span class="op">)</span><span class="op">]</span>, 
    valve_length <span class="op">=</span> <span class="va">on_opx_distance</span> <span class="op">-</span> <span class="va">on_ipx_distance</span>
  <span class="op">)</span>  <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    idt   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">ungroup</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">idt</span>, <span class="va">valve_length</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'id' (override with `.groups` argument)</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">##  Detected inner/outer edges and calculate lengths between the two ####</span>
<span class="va">tm</span>     <span class="op">&lt;-</span> <span class="va">test_methods</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">test_methods</span><span class="op">)</span><span class="op">]</span>
<span class="va">tm_lgl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_lgl</a></span><span class="op">(</span><span class="va">tm</span>, <span class="op">~</span> <span class="va">.x</span><span class="op">$</span><span class="va">zfa</span><span class="op">$</span><span class="va">.outer</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># lengths using all methods except "A"</span>
<span class="va">chem_valve_lengths</span> <span class="op">&lt;-</span> 
  <span class="va">method_tests</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">idref_method</span> <span class="op">!=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">idref_method</span>, <span class="va">id</span>, <span class="va">transect</span>, .drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    outer_edge_rn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">layer</span> <span class="op">==</span> <span class="st">"opx"</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    inner_edge_rn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">layer</span> <span class="op">==</span> <span class="st">"ipx"</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span>  <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    use_inner <span class="op">=</span> <span class="va">idref_method</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">tm</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="va">tm_lgl</span><span class="op">]</span>,
    use_outer <span class="op">=</span> <span class="va">idref_method</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">tm</span><span class="op">)</span><span class="op">[</span><span class="va">tm_lgl</span><span class="op">]</span>,
    idref_grouping <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span>
      <span class="va">idref_method</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"B-C"</span>,
      <span class="va">idref_method</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"D"</span>, <span class="st">"E"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"D-E"</span>,
      <span class="va">idref_method</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"F"</span>, <span class="st">"G"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"F-G"</span>,
      <span class="va">idref_method</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"H"</span>, <span class="st">"I"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"H-I"</span>,
      <span class="va">idref_method</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"J"</span>, <span class="st">"K"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"J-K"</span>,
      <span class="va">idref_method</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"L"</span>, <span class="st">"M"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"L-M"</span>,
      <span class="va">idref_method</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"N"</span>, <span class="st">"O"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"N-O"</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">idref_grouping</span>, <span class="va">id</span>, <span class="va">transect</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    inner_edge_rn <span class="op">=</span> <span class="va">inner_edge_rn</span><span class="op">[</span><span class="va">use_inner</span><span class="op">]</span>,
    outer_edge_rn <span class="op">=</span> <span class="va">outer_edge_rn</span><span class="op">[</span><span class="va">use_outer</span><span class="op">]</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    valve_obs <span class="op">=</span> <span class="va">outer_edge_rn</span> <span class="op">-</span> <span class="va">inner_edge_rn</span>,
    auto_detect_valve_length <span class="op">=</span> <span class="va">valve_obs</span> <span class="op">*</span> <span class="fl">2.881</span>,
    idt   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">idref_grouping</span>, <span class="va">inner_edge_rn</span>, <span class="va">outer_edge_rn</span>,
         <span class="va">idt</span>, <span class="va">auto_detect_valve_length</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'idref_method', 'id' (override with `.groups` argument)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'idref_grouping', 'id' (override with `.groups` argument)</span>

<span class="co"># lengths using method "A"</span>
<span class="va">chem_valve_lengths_A</span> <span class="op">&lt;-</span> 
  <span class="va">method_tests</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">idref_method</span> <span class="op">==</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">idref_method</span>, <span class="va">id</span>, <span class="va">transect</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    outer_edge_rn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">layer</span> <span class="op">==</span> <span class="st">"opx"</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    inner_edge_rn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">layer</span> <span class="op">==</span> <span class="st">"ipx"</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    idref_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">idref_method</span><span class="op">)</span>,
    idt   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span>
    idref_grouping <span class="op">=</span> <span class="va">idref_method</span>, <span class="va">idt</span>, <span class="va">inner_edge_rn</span>, <span class="va">outer_edge_rn</span>
  <span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'idref_method', 'id' (override with `.groups` argument)</span>

<span class="va">chem_valve_lengths</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">chem_valve_lengths</span>, <span class="va">chem_valve_lengths_A</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">## Compare valve lengths measured to valve lengths auto detected ####</span>
<span class="va">valve_length_compare</span> <span class="op">&lt;-</span> <span class="va">chem_valve_lengths</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">valve_lengths</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"idt"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    difference <span class="op">=</span> <span class="va">auto_detect_valve_length</span> <span class="op">-</span> <span class="va">valve_length</span>,
    rel_diff   <span class="op">=</span> <span class="va">difference</span><span class="op">/</span><span class="va">valve_length</span>
  <span class="op">)</span>

<span class="va">best_method_by_idt</span> <span class="op">&lt;-</span> 
  <span class="va">valve_length_compare</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">idref_grouping</span> <span class="op">!=</span> <span class="st">"A"</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">rel_diff</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span>
    <span class="va">chem_valve_lengths_A</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">idt</span>, A_iedge <span class="op">=</span> <span class="va">inner_edge_rn</span><span class="op">)</span>, 
    by <span class="op">=</span> <span class="st">"idt"</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">idt</span>, .drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    is_min_rel_diff   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">rel_diff</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">rel_diff</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    iedge_Adiff       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">A_iedge</span> <span class="op">-</span> <span class="va">inner_edge_rn</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">is_min_rel_diff</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    is_min_Adiff <span class="op">=</span> <span class="va">iedge_Adiff</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">iedge_Adiff</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co"># filter(sum(is_min_Adiff) &gt; 1) %&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    which_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">is_min_Adiff</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span>,
                          <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">is_min_Adiff</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,
                          <span class="fl">1</span><span class="op">)</span>,
    best_method   <span class="op">=</span> <span class="va">idref_grouping</span><span class="op">[</span><span class="va">which_method</span><span class="op">]</span>,
    inner_edge_rn <span class="op">=</span> <span class="va">inner_edge_rn</span><span class="op">[</span><span class="va">which_method</span><span class="op">]</span>,
    outer_edge_rn <span class="op">=</span> <span class="va">outer_edge_rn</span><span class="op">[</span><span class="va">which_method</span><span class="op">]</span>,
    difference    <span class="op">=</span> <span class="va">difference</span><span class="op">[</span><span class="va">which_method</span><span class="op">]</span>,
    rel_diff      <span class="op">=</span> <span class="va">rel_diff</span><span class="op">[</span><span class="va">which_method</span><span class="op">]</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">which_method</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>

<span class="va">valve_length_compare</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span>
  <span class="va">valve_length_compare</span>,
  <span class="fu">mutate</span><span class="op">(</span><span class="va">best_method_by_idt</span>, idref_grouping  <span class="op">=</span> <span class="st">"best"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="visualize-differences-between-the-manual-measurement-and-aligment-method" class="section level3">
<h3 class="hasAnchor">
<a href="#visualize-differences-between-the-manual-measurement-and-aligment-method" class="anchor"></a>Visualize differences between the manual measurement and aligment method</h3>
<p>In relative terms:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">valve_length_compare</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">idref_grouping</span> <span class="op">!=</span> <span class="st">"A"</span><span class="op">)</span>,
  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">rel_diff</span><span class="op">)</span>
<span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_dotplot</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">.01</span>, dotsize <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">idref_grouping</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 9 rows containing non-finite values (stat_bindot).</span></code></pre></div>
<p><img src="preprocess_data_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
<p>In absolute terms:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">valve_length_compare</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">idref_grouping</span> <span class="op">!=</span> <span class="st">"A"</span><span class="op">)</span>,
  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">difference</span><span class="op">)</span>
<span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_dotplot</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">10</span>, dotsize <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">idref_grouping</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 9 rows containing non-finite values (stat_bindot).</span></code></pre></div>
<p><img src="preprocess_data_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
<div id="qc-plot-inner-edge-ca43_cps-and-pb208_cps-for-each-idtransect" class="section level4">
<h4 class="hasAnchor">
<a href="#qc-plot-inner-edge-ca43_cps-and-pb208_cps-for-each-idtransect" class="anchor"></a>QC: Plot inner edge Ca43_CPS and Pb208_CPS for each id/transect</h4>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">inner_edge</span> <span class="op">&lt;-</span> <span class="va">method_tests</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>idt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">distance</span> <span class="op">&lt;</span> <span class="fl">250</span>, <span class="va">idref_method</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"D"</span>, <span class="st">"F"</span>, <span class="st">"H"</span>, <span class="st">"J"</span>, <span class="st">"L"</span><span class="op">)</span><span class="op">)</span> 

<span class="va">inner_edge_best</span> <span class="op">&lt;-</span> <span class="va">inner_edge</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span>
    <span class="va">valve_length_compare</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">idref_grouping</span> <span class="op">==</span> <span class="st">"best"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">idt</span>, <span class="va">best_method</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="st">"idt"</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">best_method</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">idref_method</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    idref_method <span class="op">=</span> <span class="st">"best"</span>
  <span class="op">)</span>

<span class="va">plotdt</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">inner_edge</span>, <span class="va">inner_edge_best</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">plotdt</span> ,
  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">distance</span>, y <span class="op">=</span> <span class="va">Ca43_CPS</span>, group <span class="op">=</span> <span class="va">idt</span><span class="op">)</span>
<span class="op">)</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">idref_method</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span></code></pre></div>
<p><img src="preprocess_data_files/figure-html/unnamed-chunk-29-1.png" width="700"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">plotdt</span> ,
  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">distance</span>, y <span class="op">=</span> <span class="va">Pb208_CPS</span>, group <span class="op">=</span> <span class="va">idt</span><span class="op">)</span>
<span class="op">)</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">idref_method</span> <span class="op">~</span> <span class="va">.</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span></code></pre></div>
<p><img src="preprocess_data_files/figure-html/unnamed-chunk-30-1.png" width="700"></p>
</div>
</div>
<div id="find-grouping-with-smallest-error" class="section level3">
<h3 class="hasAnchor">
<a href="#find-grouping-with-smallest-error" class="anchor"></a>Find grouping with smallest error</h3>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">best_grouping</span> <span class="op">&lt;-</span> 
  <span class="va">valve_length_compare</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">idref_grouping</span> <span class="op">!=</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">idref_grouping</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>
    MB  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">difference</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    MSE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">difference</span><span class="op">^</span><span class="fl">2</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    MAD <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">difference</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">MSE</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">MSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">pull</span><span class="op">(</span><span class="va">idref_grouping</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span></code></pre></div>
<div id="qc-check-that-for-all-idtransects-relative-difference-is-below-a-threshold" class="section level4">
<h4 class="hasAnchor">
<a href="#qc-check-that-for-all-idtransects-relative-difference-is-below-a-threshold" class="anchor"></a>QC: Check that for all id/transects relative difference is below a threshold</h4>
<pre><code>##
rel_diff_threshold &lt;- 0.02
valve_length_compare %&gt;%
  filter(idref_grouping == best_method, abs(rel_diff) &gt; rel_diff_threshold) %&gt;%
  arrange(desc(abs(rel_diff)))</code></pre>
</div>
</div>
<div id="update-valve_data-with-the-best-aligment-method" class="section level3">
<h3 class="hasAnchor">
<a href="#update-valve_data-with-the-best-aligment-method" class="anchor"></a>Update valve_data with the “best” aligment method</h3>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">distances</span> <span class="op">&lt;-</span> 
  <span class="va">method_tests</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>idt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">idref_method</span>  <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"D"</span>, <span class="st">"F"</span>, <span class="st">"H"</span>, <span class="st">"J"</span>, <span class="st">"L"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span>
    <span class="va">valve_length_compare</span> <span class="op">%&gt;%</span> 
      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">idref_grouping</span> <span class="op">==</span> <span class="st">"best"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">idt</span>, <span class="va">best_method</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="st">"idt"</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">best_method</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">idref_method</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">valve_data</span> <span class="op">&lt;-</span> <span class="va">valve_data</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">distance</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">distances</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"transect"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span>, distance <span class="op">=</span> <span class="va">data</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="final-data-preparations" class="section level2">
<h2 class="hasAnchor">
<a href="#final-data-preparations" class="anchor"></a>Final data preparations</h2>
<div id="add-information-about-annuli-availablity-within-each-idtransect" class="section level3">
<h3 class="hasAnchor">
<a href="#add-information-about-annuli-availablity-within-each-idtransect" class="anchor"></a>Add information about annuli availablity within each id/transect</h3>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">valve_annual_layer_availability</span> <span class="op">&lt;-</span> <span class="va">valve_data</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span>, <span class="va">distance</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">layer</span> <span class="op">==</span> <span class="st">"ncr"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">annuli</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span>
    key <span class="op">=</span> <span class="va">annuli</span>, value <span class="op">=</span> <span class="va">n</span>, fill <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>
<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(distance)`</span>
<span class="co">#&gt; Warning: The `add` argument of `group_by()` is deprecated as of dplyr 1.0.0.</span>
<span class="co">#&gt; Please use the `.add` argument instead.</span>
<span class="co">#&gt; This warning is displayed once every 8 hours.</span>
<span class="co">#&gt; Call `lifecycle::last_warnings()` to see where this warning was generated.</span>
<span class="co">#&gt; `summarise()` regrouping output by 'id', 'transect' (override with `.groups` argument)</span>

<span class="va">valve_data</span> <span class="op">&lt;-</span> 
  <span class="va">valve_data</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">valve_annual_layer_availability</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"transect"</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
</div>
<div id="compute-age-estimate-from-measured-annuli" class="section level3">
<h3 class="hasAnchor">
<a href="#compute-age-estimate-from-measured-annuli" class="anchor"></a>Compute age estimate from measured annuli</h3>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_annuli</span> <span class="op">&lt;-</span>  
  <span class="va">valve_data</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise_at</span><span class="op">(</span>.vars <span class="op">=</span> <span class="fu">vars</span><span class="op">(</span><span class="fu">matches</span><span class="op">(</span><span class="st">"^[A-Z]$"</span><span class="op">)</span><span class="op">)</span>, .funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">transmute</span><span class="op">(</span>
    id       <span class="op">=</span> <span class="va">id</span>,
    n_annuli <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">.</span><span class="op">[</span> , <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
</div>
<div id="add-covariates-and-outcomes" class="section level3">
<h3 class="hasAnchor">
<a href="#add-covariates-and-outcomes" class="anchor"></a>Add covariates and outcomes</h3>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Add covariates and outcome variables ####</span>
<span class="va">mussel_info</span> <span class="op">&lt;-</span> 
  <span class="va">valve_data</span> <span class="op">%&gt;%</span> 
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">distinct</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># add river, site, and other info</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">mussels_wide</span>, by <span class="op">=</span> <span class="st">'id'</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    prop_weight_lost <span class="op">=</span> <span class="op">(</span><span class="va">buoyant_weight_g_1</span> <span class="op">-</span> <span class="va">buoyant_weight_g_0</span><span class="op">)</span><span class="op">/</span><span class="va">buoyant_weight_g_0</span>,
    river <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">river</span><span class="op">)</span>, <span class="st">"Baseline"</span>, <span class="va">river</span><span class="op">)</span>,
    site  <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">river</span> <span class="op">==</span> <span class="st">"Baseline"</span>, <span class="st">"Baseline"</span>, <span class="va">site</span><span class="op">)</span>,
    species <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>,
                      true <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span>
                        <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">'A'</span>, <span class="va">id</span><span class="op">)</span> <span class="op">~</span> <span class="st">'A. raveneliana'</span>,
                        <span class="cn">TRUE</span>  <span class="op">~</span> <span class="st">'L. fasciola'</span><span class="op">)</span>,
                      false <span class="op">=</span> <span class="va">species</span><span class="op">)</span>,
    moribund      <span class="op">=</span> <span class="op">(</span><span class="va">prop_weight_lost</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.3</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1</span>,
    moribund      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">moribund</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">moribund</span><span class="op">)</span>,
    dead          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">river</span> <span class="op">==</span> <span class="st">'Baseline'</span>, <span class="fl">0</span>, <span class="va">dead</span><span class="op">)</span>,
    final_status  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dead</span>, <span class="st">'Dead'</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">moribund</span>, <span class="st">'Moribund'</span>, <span class="st">'Alive'</span><span class="op">)</span><span class="op">)</span>,
    final_status  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">final_status</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span>, 
                           levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Alive'</span>, <span class="st">'Moribund'</span>, <span class="st">'Dead'</span><span class="op">)</span><span class="op">)</span>,
    site_num      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu">if_else</span><span class="op">(</span><span class="va">site</span> <span class="op">==</span> <span class="st">"Baseline"</span>, <span class="st">"1"</span>, <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">site</span>, <span class="fl">6</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    baseline_volume <span class="op">=</span> <span class="va">volume_0</span>,
    baseline_width  <span class="op">=</span> <span class="va">width_mm_0</span>,
    baseline_length <span class="op">=</span> <span class="va">length_mm_0</span>,
    baseline_height <span class="op">=</span> <span class="va">height_mm_0</span>,
    baseline_weight <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"A. raveneliana"</span>,
                              <span class="va">buoyant_weight_g_0</span>,
                              <span class="va">dry_weight_g_0</span><span class="op">)</span> 
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">site</span>, <span class="va">site_num</span>, <span class="va">river</span>, <span class="va">species</span>, <span class="va">dead</span>,
                <span class="fu">starts_with</span><span class="op">(</span><span class="st">"baseline_"</span><span class="op">)</span>,
                <span class="va">prop_weight_lost</span>, <span class="va">moribund</span>, <span class="va">final_status</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">n_annuli</span>, by <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span>

<span class="va">valve_data</span> <span class="op">&lt;-</span> 
  <span class="va">valve_data</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span><span class="va">mussel_info</span>, by <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></code></pre></div>
</div>
<div id="add-analysis-subgrouping-indicators" class="section level3">
<h3 class="hasAnchor">
<a href="#add-analysis-subgrouping-indicators" class="anchor"></a>Add analysis subgrouping indicators</h3>
<ul>
<li>
<code>agrp_any_A</code>: id has any transect with nacre annuli A</li>
<li>
<code>agrp_any_B</code>: id has any transect with nacre annuli B</li>
<li>
<code>agrp_first_transect</code>: first transect of an id</li>
<li>
<code>agrp_first_transect_with_A</code>: first transect of an id with nacre annuli A</li>
<li>
<code>agrp_transect_most_A:</code> longest transects of an id with the most annuli A</li>
<li>
<code>agrp_first_transect_with_B</code>: first transect of an id with nacre annuli B</li>
<li>
<code>agrp_first_transect_with_AB</code>: first transect of an id with nacre annuli A AND B</li>
</ul>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Find the transect of an id with the longest section of annuli A</span>
<span class="va">most_A</span> <span class="op">&lt;-</span> <span class="va">valve_data</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span>, <span class="va">distance</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">distance</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span>, <span class="va">layer</span>, <span class="va">annuli</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>d <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">layer</span> <span class="op">==</span> <span class="st">"ncr"</span>, <span class="va">annuli</span> <span class="op">==</span> <span class="st">"A"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">d</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    agrp_transect_most_A <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>
<span class="co">#&gt; `summarise()` regrouping output by 'id', 'transect', 'layer' (override with `.groups` argument)</span>

<span class="va">valve_data</span> <span class="op">&lt;-</span> 
  <span class="va">valve_data</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    agrp_any_A                  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>,
    agrp_any_B                  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span>,
    agrp_first_transect         <span class="op">=</span> <span class="op">(</span><span class="va">transect</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">transect</span><span class="op">)</span><span class="op">)</span>,
    firstA_transect             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span>
      <span class="va">agrp_any_A</span>, <span class="va">transect</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, <span class="st">""</span><span class="op">)</span>,
    firstB_transect             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span>
      <span class="va">agrp_any_B</span>, <span class="va">transect</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, <span class="st">""</span><span class="op">)</span>,
    agrp_first_transect_with_A  <span class="op">=</span> <span class="op">(</span><span class="va">transect</span> <span class="op">==</span> <span class="va">firstA_transect</span><span class="op">)</span>,
    agrp_first_transect_with_B  <span class="op">=</span> <span class="op">(</span><span class="va">transect</span> <span class="op">==</span> <span class="va">firstB_transect</span><span class="op">)</span>,  
    agrp_first_transect_with_AB <span class="op">=</span> <span class="op">(</span><span class="va">transect</span> <span class="op">==</span> <span class="va">firstA_transect</span><span class="op">)</span> <span class="op">&amp;</span>
                                  <span class="op">(</span><span class="va">transect</span> <span class="op">==</span> <span class="va">firstB_transect</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">left_join</span><span class="op">(</span><span class="va">most_A</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"transect"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    agrp_transect_most_A <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">agrp_transect_most_A</span><span class="op">)</span>, 
                                   <span class="cn">FALSE</span>, 
                                   <span class="va">agrp_transect_most_A</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">firstA_transect</span>, <span class="op">-</span><span class="va">firstB_transect</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">valve_data</span>, file <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">outputs</span><span class="op">$</span><span class="va">valve_data</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="create-a-dataset-of-data-on-elements-measured-by-la-icp-ms" class="section level2">
<h2 class="hasAnchor">
<a href="#create-a-dataset-of-data-on-elements-measured-by-la-icp-ms" class="anchor"></a>Create a dataset of data on elements measured by LA-ICP-MS</h2>
<p>This uses the <code>PeriodicTable</code> package <span class="citation">(Idé 2017)</span></p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"periodicTable"</span>, package <span class="op">=</span> <span class="st">"PeriodicTable"</span><span class="op">)</span>

<span class="va">element_info</span> <span class="op">&lt;-</span> 
  <span class="fu">left_join</span><span class="op">(</span><span class="va">valve_data</span><span class="op">$</span><span class="va">chemistry</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, 
            <span class="va">valve_data</span><span class="op">$</span><span class="va">distance</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, 
            by <span class="op">=</span> <span class="st">"obs"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="fu">ends_with</span><span class="op">(</span><span class="st">"value_raw"</span><span class="op">)</span>, <span class="op">-</span><span class="fu">ends_with</span><span class="op">(</span><span class="st">"censor"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">idt</span>, <span class="op">-</span><span class="va">idref_method</span>, <span class="op">-</span><span class="va">best_method</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/create_long_analysis_data.html">create_long_analysis_data</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">distinct</span><span class="op">(</span><span class="va">element</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>
      symb <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">element</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">'[A-Za-z]+'</span><span class="op">)</span>,
      element_label <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="va">element</span>, <span class="st">'_ppm'</span>, <span class="st">''</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">left_join</span><span class="op">(</span>
      <span class="va">periodicTable</span> <span class="op">%&gt;%</span>
      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">symb</span>, <span class="va">name</span>, <span class="va">group</span>, <span class="va">period</span>, <span class="va">type</span>, <span class="va">mass</span>, <span class="va">color</span><span class="op">)</span>,
      by <span class="op">=</span> <span class="st">'symb'</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">element_info</span>, file <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">outputs</span><span class="op">$</span><span class="va">element_info</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="et-cetera" class="section level1">
<h1 class="hasAnchor">
<a href="#et-cetera" class="anchor"></a>Et cetera</h1>
<div id="randomly-select-two-specimens-of-each-species-for-measuring-ca-concentrations" class="section level2">
<h2 class="hasAnchor">
<a href="#randomly-select-two-specimens-of-each-species-for-measuring-ca-concentrations" class="anchor"></a>Randomly select two specimens of each species for measuring Ca concentrations</h2>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">valve_data</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">transect</span>,<span class="va">species</span>, <span class="va">measures</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    drawer <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">measures</span>, <span class="op">~</span><span class="va">.x</span><span class="op">$</span><span class="va">drawer</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">measures</span>, <span class="op">-</span><span class="va">transect</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">distinct</span><span class="op">(</span><span class="va">id</span>, <span class="va">species</span>, <span class="va">drawer</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    picks <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu">sample_n</span><span class="op">(</span><span class="va">.x</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Warning: `cols` is now required when using unnest().</span>
<span class="co">#&gt; Please use `cols = c(picks)`</span>
<span class="co">#&gt; # A tibble: 4 x 3</span>
<span class="co">#&gt; # Groups:   species [2]</span>
<span class="co">#&gt;   species        id    drawer</span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;chr&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 A. raveneliana C495       2</span>
<span class="co">#&gt; 2 A. raveneliana C473       4</span>
<span class="co">#&gt; 3 L. fasciola    P098       4</span>
<span class="co">#&gt; 4 L. fasciola    P152       6</span>
  
<span class="co"># Oops! Forgot to set the random seed. The results were:</span>
<span class="co"># A tibble: 4 x 3</span>
<span class="co"># species        id    drawer</span>
<span class="co"># &lt;chr&gt;          &lt;chr&gt;  &lt;dbl&gt;</span>
<span class="co">#   1 A. raveneliana C468       1</span>
<span class="co"># 2 A. raveneliana C531       3</span>
<span class="co"># 3 L. fasciola    P108       4</span>
<span class="co"># 4 L. fasciola    P106       4</span></code></pre></div>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references hanging-indent">
<div id="ref-ide2017periodic">
<p>Idé, Julien. 2017. <em>PeriodicTable: Periodic Table of the Elements</em>. <a href="https://CRAN.R-project.org/package=PeriodicTable">https://CRAN.R-project.org/package=PeriodicTable</a>.</p>
</div>
<div id="ref-killick2014changepoint">
<p>Killick, Rebecca, and Idris A. Eckley. 2014. “changepoint: An R Package for Changepoint Analysis.” <em>Journal of Statistical Software</em> 58 (3): 1–19. <a href="http://www.jstatsoft.org/v58/i03/">http://www.jstatsoft.org/v58/i03/</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Bradley Saul.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
